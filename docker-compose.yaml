volumes:
  npm:
  git:
  komodo:
  adblock:
  portainer:
  letsencrypt:
  mongo:
  mongo-config:

services:

  # nginx:
  #   image: nginx:latest
  #   ports:
  #     - 443:443
  #   volumes:
  #     - ./certs:/etc/ssl/certs
  #     - ./nginx.conf:/etc/nginx/conf.d/default.conf

  npm:
    container_name: proxy
    image: jc21/nginx-proxy-manager:latest
    restart: unless-stopped
    ports:
      - 80:80
      - 443:443 
      - 81:81 
    environment:
      INITIAL_ADMIN_PASSWORD: changemenow
      INITIAL_ADMIN_EMAIL: test@gmail.com
      TZ: "America/Vancouver"
    volumes:
      - npm:/data
      - letsencrypt:/etc/letsencrypt

  atlas:
    image: keinstien/atlas:latest
    container_name: network
    network_mode: host
    cap_add:
      - NET_RAW
      - NET_ADMIN
    environment:
      - ATLAS_UI_PORT=8884
      - ATLAS_API_PORT=8885
      - FASTSCAN_INTERVAL=3600
      - DOCKERSCAN_INTERVAL=3600
      - DEEPSCAN_INTERVAL=7200
      - SCAN_SUBNETS=192.168.1.0/24,10.0.0.0/24
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  portainer:
    container_name: docker
    image: portainer/portainer-ce:lts
    restart: always
    ports:
      - 8000:8000
      - 9443:9443
    volumes:
      - portainer:/data
      - /var/run/docker.sock:/var/run/docker.sock

  git:
    container_name: git
    image: codeberg.org/forgejo/forgejo:13
    restart: always
    ports:
      - 3000:3000
      - 222:22
    environment:
      - USER_UID=1000
      - USER_GID=1000
    volumes:
      - git:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

  adblock:
    image: pihole/pihole:latest
    container_name: adblock
    restart: unless-stopped
    network_mode: host
    environment:
      - WEB_PORT=8080  
      - FTLCONF_webserver_port=8080
      - TZ=America/Vancouver
      - FTLCONF_webserver_api_password=x
      - FTLCONF_dns_listeningMode=ALL
    cap_add:
      - NET_ADMIN
      - SYS_TIME
      - SYS_NICE
    volumes:
      - adblock:/etc/pihole

  mongo:
    image: mongo
    container_name: build-database
    labels:
      komodo.skip: # Prevent Komodo from stopping with StopAllContainers
    command: --quiet --wiredTigerCacheSizeGB 0.25
    restart: unless-stopped
    # ports:
    #   - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${KOMODO_DB_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${KOMODO_DB_PASSWORD}
    volumes:
      - mongo:/data/db
      - mongo-config:/data/configdb
  core:
    image: ghcr.io/moghtech/komodo-core:${COMPOSE_KOMODO_IMAGE_TAG:-latest}
    container_name: build
    labels:
      komodo.skip: # Prevent Komodo from stopping with StopAllContainers
    restart: unless-stopped
    depends_on:
      - mongo
    ports:
      - 9120:9120
    env_file: 
      - ./.env
    environment:
      KOMODO_DATABASE_ADDRESS: mongo:27017
      KOMODO_DATABASE_USERNAME: ${KOMODO_DB_USERNAME}
      KOMODO_DATABASE_PASSWORD: ${KOMODO_DB_PASSWORD}
    volumes:
      - komodo:/backups

  periphery:
    image: ghcr.io/moghtech/komodo-periphery:${COMPOSE_KOMODO_IMAGE_TAG:-latest}
    container_name: build-periphery
    labels:
      komodo.skip: # Prevent Komodo from stopping with StopAllContainers
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/proc
      - /etc/komodo:/etc/komodo

  speedtest:
      restart: unless-stopped
      container_name: speedtest
      ports:
          - 3002:3000
          - 3001:3001
      image: openspeedtest/latest

